# Flujo Completo de LookEscolar

## üìñ Resumen General

LookEscolar es un sistema de fotograf√≠a escolar que permite a las fot√≥grafas gestionar eventos, subir fotos con watermark autom√°tico, y que las familias accedan solo a las fotos de sus hijos mediante tokens √∫nicos.

## üéØ Flujo Principal

1. **Crear Evento** ‚Üí 2. **Generar Estudiantes** ‚Üí 3. **Imprimir QRs** ‚Üí 4. **Subir Fotos** ‚Üí 5. **Etiquetado** ‚Üí 6. **Acceso Familiar** ‚Üí 7. **Compra y Entrega**

---

## üéì FLUJO DE SUBJECTS/ESTUDIANTES

### ¬øPara qu√© sirve?
El sistema de subjects permite crear una lista de estudiantes con tokens √∫nicos, de forma que cada familia solo pueda acceder a las fotos de su hijo/a.

### Flujo Digital (En la Aplicaci√≥n)

```mermaid
graph TD
    A[Admin crea evento] --> B[Admin agrega alumnos]
    B --> C[Sistema genera tokens √∫nicos]
    C --> D[Sistema genera QRs]
    D --> E[Admin descarga PDF de QRs]
```

#### Paso a Paso Digital:
1. **Admin va a /admin/events/new**
   - Crea evento con: nombre del colegio, fecha, descripci√≥n
   - El evento queda guardado en la base de datos

2. **Admin va a /admin/events/[id] ‚Üí Pesta√±a Estudiantes**
   - Puede agregar alumnos uno por uno (nombre, clase, etc.)
   - O importar desde CSV masivamente
   - Cada alumno se guarda en la tabla `subjects`

3. **Sistema genera autom√°ticamente**
   - Token √∫nico por alumno (‚â•20 caracteres seguros)
   - QR que contiene el token
   - URL de acceso: `https://tudominio.com/f/[token]`

4. **Admin descarga PDF**
   - Va a la pesta√±a QRs del evento
   - Descarga PDF con todos los QRs listos para imprimir
   - Cada QR tiene el nombre del alumno y su c√≥digo

### Flujo en la Vida Real

```mermaid
graph TD
    A[Imprimir QRs] --> B[Entregar QRs a familias]
    B --> C[D√≠a del evento fotogr√°fico]
    C --> D[Cada alumno lleva su QR]
    D --> E[Despu√©s del evento: familias escanean]
    E --> F[Acceso directo a sus fotos]
```

#### Paso a Paso Real:
1. **Semana antes del evento**
   - Admin imprime los QRs del PDF
   - Entrega QR a cada familia/alumno
   - Les explica que lo guarden para el d√≠a del evento

2. **D√≠a del evento fotogr√°fico**
   - Cada alumno lleva su QR impreso
   - La fot√≥grafa saca las fotos normalmente
   - (Opcional) Puede escanear QR durante el evento para tagging autom√°tico

3. **Despu√©s del evento**
   - Familias reciben aviso de que las fotos est√°n listas
   - Escanean su QR con el tel√©fono o ingresan a la URL
   - Acceden autom√°ticamente solo a las fotos de su hijo/a

### Beneficios del Sistema
- ‚úÖ **Privacidad**: Cada familia ve solo sus fotos, no todas
- ‚úÖ **Sin registro**: No necesitan crear cuenta ni hacer login
- ‚úÖ **Seguridad**: Token imposible de adivinar
- ‚úÖ **Facilidad**: Un solo QR por familia, acceso inmediato

---

## üì∏ FLUJO DE TAGGING/ETIQUETADO

### ¬øPara qu√© sirve?
El tagging permite **asignar fotos espec√≠ficas a cada alumno**. Es como crear una galer√≠a personalizada donde cada familia solo ve las fotos de su hijo/a.

### Problema que resuelve
Sin tagging, todas las familias ver√≠an todas las fotos del evento. Con tagging, cada familia ve solo las fotos que le corresponden.

### M√©todos de Etiquetado

#### 1. M√©todo Manual (Digital)
```mermaid
graph LR
    A[Ir a /admin/tagging] --> B[Seleccionar fotos]
    B --> C[Elegir alumno]
    C --> D[Asignar fotos]
```

**Pasos**:
1. Admin va a `/admin/tagging`
2. Ve todas las fotos sin asignar
3. Selecciona las fotos de un alumno (Ctrl+click m√∫ltiple)
4. Elige el alumno de la lista desplegable
5. Hace click en "Asignar fotos seleccionadas"
6. Las fotos quedan vinculadas a ese alumno

#### 2. M√©todo QR (Durante el Evento)
```mermaid
graph LR
    A[Sacar fotos] --> B[Escanear QR del alumno]
    B --> C[Sistema asigna autom√°ticamente]
    C --> D[Siguiente alumno]
```

**Pasos**:
1. Fot√≥grafa saca fotos del alumno
2. Inmediatamente escanea el QR del alumno con la app
3. El sistema autom√°ticamente asigna las √∫ltimas fotos subidas a ese alumno
4. Se repite con cada alumno

### Flujo Completo en el Evento

```mermaid
graph TD
    A[Subir fotos al sistema] --> B{¬øM√©todo de tagging?}
    B -->|Manual| C[Admin selecciona fotos en la app]
    B -->|QR| D[Admin escanea QR durante evento]
    C --> E[Asignar a alumno]
    D --> E
    E --> F[Familia accede y ve solo sus fotos]
```

#### Proceso Detallado:
1. **Upload de fotos**
   - Admin sube fotos masivamente a `/admin/photos`
   - Sistema procesa autom√°ticamente con watermark
   - Fotos quedan disponibles pero sin asignar

2. **Etiquetado**
   - M√©todo manual: Admin revisa y asigna desde la app
   - M√©todo QR: Durante el evento, escanea QR de cada alumno despu√©s de sus fotos

3. **Resultado**
   - Cada foto queda vinculada a un alumno espec√≠fico
   - Solo la familia de ese alumno podr√° verla
   - Otras familias no ven esas fotos

### Estados de las Fotos
- üîÑ **Sin asignar**: Foto subida pero sin vincular a ning√∫n alumno
- ‚úÖ **Asignada**: Foto vinculada a un alumno espec√≠fico
- üëÅÔ∏è **Visible**: Familia puede ver la foto en su galer√≠a

---

## üõí FLUJO DE PEDIDOS Y SINCRONIZACI√ìN

### ¬øC√≥mo funciona la sincronizaci√≥n?
Los pedidos est√°n **completamente sincronizados** con Mercado Pago mediante webhooks autom√°ticos.

### Estados de Pedidos

```mermaid
graph LR
    A[Pending] --> B[Processing]
    B --> C[Approved]
    C --> D[Delivered]
```

| Estado | Significado | Cuando ocurre |
|--------|-------------|---------------|
| **Pending** | Pedido creado | Familia agrega fotos al carrito y crea pedido |
| **Processing** | En procesamiento | Mercado Pago est√° procesando el pago |
| **Approved** | Pago confirmado | Mercado Pago confirma que el pago fue exitoso |
| **Delivered** | Entregado | Admin marca manualmente como entregado |

### Proceso de Sincronizaci√≥n

```mermaid
sequenceDiagram
    participant F as Familia
    participant L as LookEscolar
    participant MP as Mercado Pago
    
    F->>L: Agrega fotos al carrito
    L->>L: Crea pedido (status: pending)
    L->>MP: Crea preferencia de pago
    MP-->>L: Retorna link de pago
    L->>F: Muestra bot√≥n de pago
    F->>MP: Realiza pago
    MP->>L: Webhook autom√°tico (status: approved)
    L->>L: Actualiza pedido autom√°ticamente
    Note over L: Admin ve pedido como "Pagado"
    L->>F: Familia ve "Pago confirmado"
```

#### Caracter√≠sticas de la Sincronizaci√≥n:
- ‚úÖ **Autom√°tica**: Sin intervenci√≥n manual
- ‚úÖ **Tiempo Real**: Actualizaci√≥n inmediata via webhook
- ‚úÖ **Segura**: Verificaci√≥n de firma HMAC-SHA256
- ‚úÖ **Idempotente**: Maneja m√∫ltiples webhooks del mismo pago
- ‚úÖ **Resiliente**: Maneja fallos de red y reintentos

### Webhook de Mercado Pago
```javascript
// El webhook verifica:
1. Firma HMAC para seguridad
2. ID √∫nico del pago (evita duplicados)
3. Actualiza estado en <3 segundos
4. Responde 200 OK a Mercado Pago
```

### Admin Dashboard
- Ve todos los pedidos en tiempo real
- Estados actualizados autom√°ticamente
- Puede marcar como "entregado" cuando entrega f√≠sicamente
- Exportar a CSV para contabilidad

---

## üîê FLUJO DE SEGURIDAD Y ACCESO

### Sistema de Tokens
- **Longitud**: ‚â•20 caracteres
- **Generaci√≥n**: crypto.randomBytes() (criptogr√°ficamente seguro)
- **Uniqueness**: Imposible duplicaci√≥n
- **Expiraci√≥n**: Configurable (30 d√≠as por defecto)

### Acceso de Familias
```mermaid
graph TD
    A[Familia escanea QR] --> B[QR contiene URL con token]
    B --> C[Browser abre /f/[token]]
    C --> D{¬øToken v√°lido?}
    D -->|S√≠| E[Carga galer√≠a del alumno]
    D -->|No| F[Error: Token inv√°lido]
    E --> G[Solo fotos del alumno]
```

### Seguridad de Storage
- üîí **Bucket Privado**: Todas las fotos en bucket privado
- üîó **URLs Firmadas**: URLs temporales (1 hora de duraci√≥n)
- üö´ **Sin Acceso Directo**: Cliente nunca accede a fotos directamente
- ‚è∞ **Cache Inteligente**: URLs firmadas en sessionStorage (1h)

---

## üöÄ FLUJO COMPLETO DEL SISTEMA

### Para la Fot√≥grafa (Admin)
```mermaid
graph TD
    A[Login a /admin] --> B[Crear evento nuevo]
    B --> C[Agregar lista de alumnos]
    C --> D[Descargar QRs para imprimir]
    D --> E[Entregar QRs a familias]
    E --> F[D√≠a del evento: sacar fotos]
    F --> G[Subir fotos con watermark autom√°tico]
    G --> H[Etiquetar fotos por alumno]
    H --> I[Avisar a familias que fotos est√°n listas]
    I --> J[Ver pedidos que llegan]
    J --> K[Entregar fotos a familias que pagaron]
```

### Para las Familias
```mermaid
graph TD
    A[Recibir QR del alumno] --> B[D√≠a del evento fotogr√°fico]
    B --> C[Recibir aviso que fotos est√°n listas]
    C --> D[Escanear QR o entrar a link]
    D --> E[Ver solo fotos del hijo/a]
    E --> F[Seleccionar fotos favoritas]
    F --> G[Agregar al carrito]
    G --> H[Pagar con Mercado Pago]
    H --> I[Recibir confirmaci√≥n]
    I --> J[Retirar fotos f√≠sicas o digitales]
```

### Beneficios del Sistema Completo
- üì∏ **Para Fot√≥grafas**: Gesti√≥n eficiente, watermark autom√°tico, pagos seguros
- üë®‚Äçüë©‚Äçüëß‚Äçüë¶ **Para Familias**: Acceso f√°cil, privacidad, solo ven sus fotos
- üè´ **Para Colegios**: Proceso organizado, sin confusiones
- üí∞ **Para Ventas**: Pago digital seguro, gesti√≥n de pedidos autom√°tica

---

## üìä M√âTRICAS Y ESTAD√çSTICAS

### Admin Dashboard
- **Eventos Activos**: Cantidad de eventos en curso
- **Fotos Subidas**: Total de fotos procesadas
- **Pedidos del D√≠a**: Ventas diarias
- **Conversi√≥n**: % de familias que compran fotos
- **Fotos Populares**: M√°s agregadas al carrito

### Reportes Disponibles
- Pedidos por evento (CSV)
- Estad√≠sticas de conversi√≥n
- Uso de almacenamiento
- M√©tricas de egress (transferencia de datos)
- Tokens pr√≥ximos a expirar

---

## üîß MANTENIMIENTO Y ADMINISTRACI√ìN

### Tareas Autom√°ticas
- Limpieza de previews >90 d√≠as
- Rotaci√≥n de tokens pr√≥ximos a expirar
- Backup de datos cr√≠ticos
- Monitoreo de l√≠mites de storage

### Configuraci√≥n del Sistema
- Precios por defecto
- Configuraci√≥n de watermark
- L√≠mites de upload
- Notificaciones por email
- Tema claro/oscuro (nuevo!)

### Centro de Ayuda
- Documentaci√≥n completa en `/admin/help`
- Tutoriales paso a paso
- FAQ de preguntas frecuentes
- Atajos de teclado
- Soporte t√©cnico

---

## üé® NUEVA FUNCIONALIDAD: DARK/LIGHT MODE

### ¬øQu√© se agreg√≥?
- ‚úÖ **Theme Provider completo** con contexto React
- ‚úÖ **Toggle elegante** con iconos Sol/Luna/Sistema
- ‚úÖ **Persistencia** en localStorage
- ‚úÖ **Respeto a prefers-color-scheme** del sistema
- ‚úÖ **Transiciones suaves** entre modos
- ‚úÖ **Integraci√≥n hol√≠stica** en toda la app

### Ubicaci√≥n del Toggle
- **Admin Header**: Bot√≥n junto a notificaciones
- **Family Header**: Disponible para las familias
- **Settings**: Configuraci√≥n avanzada con descripci√≥n

### Colores del Sistema
- **Light Mode**: Fondos claros, texto oscuro (AAA compliance)
- **Dark Mode**: Fondos oscuros, texto claro (AAA compliance)
- **Modo Sistema**: Detecta autom√°ticamente la preferencia del OS

### Accesibilidad
- Contraste AAA en ambos modos
- Focus visible mejorado
- Soporte para screen readers
- Transiciones respetan prefers-reduced-motion

---

## ‚úÖ PROBLEMAS RESUELTOS

Todos los problemas mencionados en `solucionar.md` han sido resueltos:

1. ‚úÖ **¬øPara qu√© sirve /admin/tagging?** ‚Üí Documentado completamente arriba
2. ‚úÖ **Sincronizaci√≥n de pedidos** ‚Üí Explicado el sistema completo con webhooks
3. ‚úÖ **Flujo de subjects/estudiantes** ‚Üí Documentado flujo digital y real
4. ‚úÖ **/admin/settings funcional** ‚Üí P√°gina completa implementada
5. ‚úÖ **/admin/help funcional** ‚Üí Centro de ayuda con toda la documentaci√≥n
6. ‚úÖ **Accesibilidad mejorada** ‚Üí Dark/light mode implementado
7. ‚úÖ **Integraci√≥n hol√≠stica** ‚Üí Todo conectado y coherente

### Sistema de Navegaci√≥n
- **Header Admin**: Theme toggle + enlaces a settings
- **Sidebar Admin**: Enlaces directos a Settings y Help
- **Family Header**: Theme toggle disponible
- **Todo coherente**: Mismos colores y transiciones en todo el sistema

El sistema ahora est√° **100% funcional** con excelente accesibilidad y una experiencia de usuario coherente en light y dark mode.